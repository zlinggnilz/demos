import{u as r,r as y,D as _,T as w,A as k,a as S,e as a,c as x,P as p}from"./index-c79634e7.js";import{M as E,l as f,aO as P}from"./three.module-aafafa83.js";/*!
 * PhotoSphereViewer.AutorotatePlugin 5.4.2
 * @copyright 2023 Damien "Mistic" Sorel
 * @licence MIT (https://opensource.org/licenses/MIT)
 */var b=Object.defineProperty,A=(t,e)=>{for(var s in e)b(t,s,{get:e[s],enumerable:!0})},T={};A(T,{AutorotateEvent:()=>l});var g=class m extends w{constructor(e){super(m.type),this.autorotateEnabled=e}};g.type="autorotate";var l=g,I=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 41 41" overflow="visible"><g fill="currentColor" transform-origin="center" transform="scale(1.3)"><path d="M40.5 14.1c-.1-.1-1.2-.5-2.898-1-.102 0-.202-.1-.202-.2C34.5 6.5 28 2 20.5 2S6.6 6.5 3.7 12.9c0 .1-.1.1-.2.2-1.7.6-2.8 1-2.9 1l-.6.3v12.1l.6.2c.1 0 1.1.399 2.7.899.1 0 .2.101.2.199C6.3 34.4 12.9 39 20.5 39c7.602 0 14.102-4.6 16.9-11.1 0-.102.1-.102.199-.2 1.699-.601 2.699-1 2.801-1l.6-.3V14.3l-.5-.2zM6.701 11.5C9.7 7 14.8 4 20.5 4c5.8 0 10.9 3 13.8 7.5.2.3-.1.6-.399.5-3.799-1-8.799-2-13.6-2-4.7 0-9.5 1-13.2 2-.3.1-.5-.2-.4-.5zM25.1 20.3L18.7 24c-.3.2-.7 0-.7-.5v-7.4c0-.4.4-.6.7-.4l6.399 3.8c.301.1.301.6.001.8zm9.4 8.901A16.421 16.421 0 0 1 20.5 37c-5.9 0-11.1-3.1-14-7.898-.2-.302.1-.602.4-.5 3.9 1 8.9 2.1 13.6 2.1 5 0 9.9-1 13.602-2 .298-.1.5.198.398.499z"/></g><!--Created by Nick Bluth from the Noun Project--></svg>
`,M=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 41 41" overflow="visible"><g fill="currentColor" transform-origin="center" transform="scale(1.3)"><path d="M40.5 14.1c-.1-.1-1.2-.5-2.899-1-.101 0-.2-.1-.2-.2C34.5 6.5 28 2 20.5 2S6.6 6.5 3.7 12.9c0 .1-.1.1-.2.2-1.7.6-2.8 1-2.9 1l-.6.3v12.1l.6.2c.1 0 1.1.4 2.7.9.1 0 .2.1.2.199C6.3 34.4 12.9 39 20.5 39c7.601 0 14.101-4.6 16.9-11.1 0-.101.1-.101.2-.2 1.699-.6 2.699-1 2.8-1l.6-.3V14.3l-.5-.2zM20.5 4c5.8 0 10.9 3 13.8 7.5.2.3-.1.6-.399.5-3.8-1-8.8-2-13.6-2-4.7 0-9.5 1-13.2 2-.3.1-.5-.2-.4-.5C9.7 7 14.8 4 20.5 4zm0 33c-5.9 0-11.1-3.1-14-7.899-.2-.301.1-.601.4-.5 3.9 1 8.9 2.1 13.6 2.1 5 0 9.9-1 13.601-2 .3-.1.5.2.399.5A16.422 16.422 0 0 1 20.5 37zm18.601-12.1c0 .1-.101.3-.2.3-2.5.9-10.4 3.6-18.4 3.6-7.1 0-15.6-2.699-18.3-3.6C2.1 25.2 2 25 2 24.9V16c0-.1.1-.3.2-.3 2.6-.9 10.6-3.6 18.2-3.6 7.5 0 15.899 2.7 18.5 3.6.1 0 .2.2.2.3v8.9z"/><path d="M18.7 24l6.4-3.7c.3-.2.3-.7 0-.8l-6.4-3.8c-.3-.2-.7 0-.7.4v7.4c0 .5.4.7.7.5z"/></g><!--Created by Nick Bluth from the Noun Project--></svg>
`,d=class extends k{constructor(t){var e;super(t,{className:"psv-autorotate-button",hoverScale:!0,collapsable:!0,tabbable:!0,icon:M,iconActive:I}),this.plugin=this.viewer.getPlugin("autorotate"),(e=this.plugin)==null||e.addEventListener(l.type,this)}destroy(){var t;(t=this.plugin)==null||t.removeEventListener(l.type,this),super.destroy()}isSupported(){return!!this.plugin}handleEvent(t){t instanceof l&&this.toggleActive(t.autorotateEnabled)}onClick(){this.plugin.isEnabled()&&(this.plugin.config.autostartOnIdle=!1),this.plugin.toggle()}};d.id="autorotate";var C=r.getConfigParser({autostartDelay:2e3,autostartOnIdle:!0,autorotateSpeed:r.parseSpeed("2rpm"),autorotatePitch:null,autorotateZoomLvl:null,keypoints:null,startFromClosest:!0},{autostartOnIdle:(t,{rawConfig:e})=>t&&r.isNil(e.autostartDelay)?(r.logWarn("autostartOnIdle requires a non null autostartDelay"),!1):t,autorotateSpeed:t=>r.parseSpeed(t),autorotatePitch:t=>r.isNil(t)?null:r.parseAngle(t,!0),autorotateZoomLvl:t=>r.isNil(t)?null:E.clamp(t,0,100)}),u=16;function h(t){return[t.yaw,t.pitch]}var c=class extends S{constructor(t,e){super(t,e),this.state={initialStart:!0,enabled:!1,idx:-1,curve:[],startStep:null,endStep:null,startTime:null,stepDuration:null,remainingPause:null,lastTime:null,tooltip:null},this.state.initialStart=!r.isNil(this.config.autostartDelay)}init(){super.init(),this.video=this.viewer.getPlugin("video"),this.markers=this.viewer.getPlugin("markers"),this.config.keypoints&&(this.setKeypoints(this.config.keypoints),delete this.config.keypoints),this.viewer.addEventListener(a.StopAllEvent.type,this),this.viewer.addEventListener(a.BeforeRenderEvent.type,this),this.video||this.viewer.addEventListener(a.KeypressEvent.type,this)}destroy(){this.viewer.removeEventListener(a.StopAllEvent.type,this),this.viewer.removeEventListener(a.BeforeRenderEvent.type,this),this.viewer.removeEventListener(a.KeypressEvent.type,this),delete this.video,delete this.markers,delete this.keypoints,super.destroy()}handleEvent(t){switch(t.type){case a.StopAllEvent.type:this.stop();break;case a.BeforeRenderEvent.type:{this.__beforeRender(t.timestamp);break}case a.KeypressEvent.type:t.key===x.KEY_CODES.Space&&this.viewer.state.keyboardEnabled&&(this.toggle(),t.preventDefault());break}}setKeypoints(t){if(!t)this.keypoints=null;else{if(t.length<2)throw new p("At least two points are required");this.keypoints=t.map((e,s)=>{const o={position:null,markerId:null,pause:0,tooltip:null};let i;if(typeof e=="string"?o.markerId=e:r.isExtendedPosition(e)?i=e:(o.markerId=e.markerId,o.pause=e.pause,i=e.position,e.tooltip&&typeof e.tooltip=="object"?o.tooltip=e.tooltip:typeof e.tooltip=="string"&&(o.tooltip={content:e.tooltip})),o.markerId){if(!this.markers)throw new p(`Keypoint #${s} references a marker but the markers plugin is not loaded`);const n=this.markers.getMarker(o.markerId);o.position=h(n.state.position)}else if(i)o.position=h(this.viewer.dataHelper.cleanPosition(i));else throw new p(`Keypoint #${s} is missing marker or position`);return o})}this.isEnabled()&&(this.stop(),this.start())}isEnabled(){return this.state.enabled}start(){this.isEnabled()||(this.viewer.stopAll(),this.keypoints?this.config.startFromClosest&&this.__shiftKeypoints():this.__animate(),this.state.initialStart=!1,this.state.enabled=!0,this.dispatchEvent(new l(!0)))}stop(){this.isEnabled()&&(this.__hideTooltip(),this.__reset(),this.viewer.stopAnimation(),this.viewer.dynamics.position.stop(),this.viewer.dynamics.zoom.stop(),this.state.enabled=!1,this.dispatchEvent(new l(!1)))}toggle(){this.isEnabled()?this.stop():this.start()}reverse(){this.isEnabled()&&!this.keypoints&&(this.config.autorotateSpeed=-this.config.autorotateSpeed,this.__animate())}__animate(){let t;r.isNil(this.config.autorotateZoomLvl)?t=Promise.resolve(!0):t=this.viewer.animate({zoom:this.config.autorotateZoomLvl,speed:`${this.viewer.config.zoomSpeed*2}rpm`}),t.then(e=>{e&&(this.viewer.dynamics.position.roll({yaw:this.config.autorotateSpeed<0},Math.abs(this.config.autorotateSpeed/this.viewer.config.moveSpeed)),this.viewer.dynamics.position.goto({pitch:this.config.autorotatePitch??this.viewer.config.defaultPitch},Math.abs(this.config.autorotateSpeed/this.viewer.config.moveSpeed)))})}__reset(){this.state.idx=-1,this.state.curve=[],this.state.startStep=null,this.state.endStep=null,this.state.startTime=null,this.state.stepDuration=null,this.state.remainingPause=null,this.state.lastTime=null,this.state.tooltip=null}__beforeRender(t){(this.state.initialStart||this.config.autostartOnIdle)&&this.viewer.state.idleTime>0&&t-this.viewer.state.idleTime>this.config.autostartDelay&&this.start(),this.isEnabled()&&this.keypoints&&(this.state.startTime||(this.state.endStep=h(this.viewer.getPosition()),this.__nextStep(),this.state.startTime=t,this.state.lastTime=t),this.__nextFrame(t))}__shiftKeypoints(){const t=h(this.viewer.getPosition()),e=this.__findMinIndex(this.keypoints,s=>r.greatArcDistance(s.position,t));this.keypoints.push(...this.keypoints.splice(0,e))}__incrementIdx(){this.state.idx++,this.state.idx===this.keypoints.length&&(this.state.idx=0)}__showTooltip(){const t=this.keypoints[this.state.idx];if(t.tooltip){const e=this.viewer.dataHelper.vector3ToViewerCoords(this.viewer.state.direction);this.state.tooltip=this.viewer.createTooltip({content:t.tooltip.content,position:t.tooltip.position,top:e.y,left:e.x})}else if(t.markerId){const e=this.markers.getMarker(t.markerId);e.showTooltip(),this.state.tooltip=e.tooltip}}__hideTooltip(){if(this.state.tooltip){const t=this.keypoints[this.state.idx];t.tooltip?this.state.tooltip.hide():t.markerId&&this.markers.getMarker(t.markerId).hideTooltip(),this.state.tooltip=null}}__nextPoint(){const t=[];if(this.state.idx===-1){const i=h(this.viewer.getPosition());t.push(i,i,this.keypoints[0].position,this.keypoints[1].position)}else for(let i=-1;i<3;i++){const n=this.state.idx+i<0?this.keypoints[this.keypoints.length-1]:this.keypoints[(this.state.idx+i)%this.keypoints.length];t.push(n.position)}const e=[new f(t[0][0],t[0][1])];let s=0;for(let i=1;i<=3;i++){const n=t[i-1][0]-t[i][0];n>Math.PI?s+=1:n<-Math.PI&&(s-=1),s!==0&&i===1&&(e[0].x-=s*2*Math.PI,s=0),e.push(new f(t[i][0]+s*2*Math.PI,t[i][1]))}const o=new P(e).getPoints(u*3).map(i=>[i.x,i.y]);this.state.curve=o.slice(u+1,u*2+1),this.state.idx!==-1?(this.state.remainingPause=this.keypoints[this.state.idx].pause,this.state.remainingPause?this.__showTooltip():this.__incrementIdx()):this.__incrementIdx()}__nextStep(){this.state.curve.length===0&&(this.__nextPoint(),this.state.endStep[0]=r.parseAngle(this.state.endStep[0])),this.state.startStep=this.state.endStep,this.state.endStep=this.state.curve.shift();const t=r.greatArcDistance(this.state.startStep,this.state.endStep);this.state.stepDuration=t*1e3/Math.abs(this.config.autorotateSpeed),t===0&&this.__nextStep()}__nextFrame(t){const e=t-this.state.lastTime;if(this.state.lastTime=t,this.state.remainingPause){if(this.state.remainingPause=Math.max(0,this.state.remainingPause-e),this.state.remainingPause>0)return;this.__hideTooltip(),this.__incrementIdx(),this.state.startTime=t}let s=(t-this.state.startTime)/this.state.stepDuration;s>=1&&(this.__nextStep(),s=0,this.state.startTime=t),this.viewer.rotate({yaw:this.state.startStep[0]+(this.state.endStep[0]-this.state.startStep[0])*s,pitch:this.state.startStep[1]+(this.state.endStep[1]-this.state.startStep[1])*s})}__findMinIndex(t,e){let s=0,o=Number.MAX_VALUE;return t.forEach((i,n)=>{const v=e(i);v<o&&(o=v,s=n)}),s}};c.id="autorotate";c.configParser=C;c.readonlyOptions=["keypoints"];y(d,"start");_.lang[d.id]="Automatic rotation";export{c as A};
