import{R as Pe,j as Le}from"./index-fb03fb25.js";import{A as O}from"./index.module-79fe8c3c.js";import{u as a,D as W,r as Y,T as xe,A as G,e as l,a as Ce,P as u,c as C,b as Ae}from"./index-c79634e7.js";import{V as m,M as ze,T as Te,aN as De,a3 as N,I as je,aK as Oe,a8 as Ne,ad as He}from"./three.module-aafafa83.js";/*!
 * PhotoSphereViewer.MarkersPlugin 5.4.2
 * @copyright 2023 Damien "Mistic" Sorel
 * @licence MIT (https://opensource.org/licenses/MIT)
 */var Re=Object.defineProperty,Ve=(i,t)=>{for(var e in t)Re(i,e,{get:t[e],enumerable:!0})},Ie={};Ve(Ie,{EnterMarkerEvent:()=>se,GotoMarkerDoneEvent:()=>D,HideMarkersEvent:()=>b,LeaveMarkerEvent:()=>ee,MarkerVisibilityEvent:()=>X,MarkersPluginEvent:()=>f,RenderMarkersListEvent:()=>Me,SelectMarkerEvent:()=>oe,SelectMarkerListEvent:()=>le,SetMarkersEvent:()=>me,ShowMarkersEvent:()=>_,UnselectMarkerEvent:()=>de});var f=class extends xe{},q=class K extends f{constructor(t,e){super(K.type),this.marker=t,this.visible=e}};q.type="marker-visibility";var X=q,Z=class F extends f{constructor(t){super(F.type),this.marker=t}};Z.type="goto-marker-done";var D=Z,Q=class J extends f{constructor(t){super(J.type),this.marker=t}};Q.type="leave-marker";var ee=Q,te=class ie extends f{constructor(t){super(ie.type),this.marker=t}};te.type="enter-marker";var se=te,re=class ne extends f{constructor(t,e,s){super(ne.type),this.marker=t,this.doubleClick=e,this.rightClick=s}};re.type="select-marker";var oe=re,ae=class he extends f{constructor(t){super(he.type),this.marker=t}};ae.type="select-marker-list";var le=ae,ce=class pe extends f{constructor(t){super(pe.type),this.marker=t}};ce.type="unselect-marker";var de=ce,ve=class ge extends f{constructor(){super(ge.type)}};ve.type="hide-markers";var b=ve,fe=class ue extends f{constructor(t){super(ue.type),this.markers=t}};fe.type="set-markers";var me=fe,ye=class we extends f{constructor(){super(we.type)}};ye.type="show-markers";var _=ye,ke=class Ee extends f{constructor(t){super(Ee.type),this.markers=t}};ke.type="render-markers-list";var Me=ke,$e=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="10 9 81 81"><path fill="currentColor" d="M50.5 90S22.9 51.9 22.9 36.6 35.2 9 50.5 9s27.6 12.4 27.6 27.6S50.5 90 50.5 90zm0-66.3c-6.1 0-11 4.9-11 11s4.9 11 11 11 11-4.9 11-11-4.9-11-11-11z"/><!--Created by Rohith M S from the Noun Project--></svg>
`,S=class extends G{constructor(i){super(i,{className:"psv-markers-button",icon:$e,hoverScale:!0,collapsable:!0,tabbable:!0}),this.plugin=this.viewer.getPlugin("markers"),this.plugin&&(this.plugin.addEventListener(_.type,this),this.plugin.addEventListener(b.type,this),this.toggleActive(!0))}destroy(){this.plugin&&(this.plugin.removeEventListener(_.type,this),this.plugin.removeEventListener(b.type,this)),super.destroy()}isSupported(){return!!this.plugin}handleEvent(i){i instanceof _?this.toggleActive(!0):i instanceof b&&this.toggleActive(!1)}onClick(){this.plugin.toggleAllMarkers()}};S.id="markers";var be=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="9 9 81 81"><path fill="currentColor" d="M37.5 90S9.9 51.9 9.9 36.6 22.2 9 37.5 9s27.6 12.4 27.6 27.6S37.5 90 37.5 90zm0-66.3c-6.1 0-11 4.9-11 11s4.9 11 11 11 11-4.9 11-11-4.9-11-11-11zM86.7 55H70c-1.8 0-3.3-1.5-3.3-3.3s1.5-3.3 3.3-3.3h16.7c1.8 0 3.3 1.5 3.3 3.3S88.5 55 86.7 55zm0-25h-15a3.3 3.3 0 0 1-3.3-3.3c0-1.8 1.5-3.3 3.3-3.3h15c1.8 0 3.3 1.5 3.3 3.3 0 1.8-1.5 3.3-3.3 3.3zM56.5 73h30c1.8 0 3.3 1.5 3.3 3.3 0 1.8-1.5 3.3-3.3 3.3h-30a3.3 3.3 0 0 1-3.3-3.3 3.2 3.2 0 0 1 3.3-3.3z"/><!--Created by Rohith M S from the Noun Project--></svg>
`,M="http://www.w3.org/2000/svg",d="psvMarker",Be=a.dasherize(d),E="marker",k="markersList",A={amount:2,duration:100,easing:"linear"},Ue=(i,t)=>`
<div class="psv-panel-menu psv-panel-menu--stripped">
 <h1 class="psv-panel-menu-title">${be} ${t}</h1>
 <ul class="psv-panel-menu-list">
   ${i.map(e=>`
   <li data-${Be}="${e.id}" class="psv-panel-menu-item" tabindex="0">
     ${e.type==="image"?`<span class="psv-panel-menu-item-icon"><img src="${e.definition}"/></span>`:""}
     <span class="psv-panel-menu-item-label">${e.getListContent()}</span>
   </li>
   `).join("")}
 </ul>
</div>
`,z=class extends G{constructor(i){super(i,{className:" psv-markers-list-button",icon:be,hoverScale:!0,collapsable:!0,tabbable:!0}),this.plugin=this.viewer.getPlugin("markers"),this.plugin&&(this.viewer.addEventListener(l.ShowPanelEvent.type,this),this.viewer.addEventListener(l.HidePanelEvent.type,this))}destroy(){this.viewer.removeEventListener(l.ShowPanelEvent.type,this),this.viewer.removeEventListener(l.HidePanelEvent.type,this),super.destroy()}isSupported(){return!!this.plugin}handleEvent(i){i instanceof l.ShowPanelEvent?this.toggleActive(i.panelId===k):i instanceof l.HidePanelEvent&&this.toggleActive(!1)}onClick(){this.plugin.toggleMarkersList()}};z.id="markersList";function We(i,t,e){const[s,r]=i,[n,o]=t,h=a.greatArcDistance(i,t),c=Math.sin((1-e)*h)/Math.sin(h),g=Math.sin(e*h)/Math.sin(h),p=c*Math.cos(r)*Math.cos(s)+g*Math.cos(o)*Math.cos(n),v=c*Math.cos(r)*Math.sin(s)+g*Math.cos(o)*Math.sin(n),y=c*Math.sin(r)+g*Math.sin(o);return[Math.atan2(v,p),Math.atan2(y,Math.sqrt(p*p+v*v))]}function _e(i){const t=[i[0]];let e=0;for(let s=1;s<i.length;s++){const r=i[s-1][0]-i[s][0];r>Math.PI?e+=1:r<-Math.PI&&(e-=1),t.push([i[s][0]+e*2*Math.PI,i[s][1]])}return t}function H(i){const e=_e(i).reduce((s,r)=>[s[0]+r[0],s[1]+r[1]]);return[a.parseAngle(e[0]/i.length),e[1]/i.length]}function Ye(i){const t=_e(i);let e=0;const s=[];for(let n=0;n<t.length-1;n++){const o=a.greatArcDistance(t[n],t[n+1])*C.SPHERE_RADIUS;s.push(o),e+=o}let r=0;for(let n=0;n<t.length-1;n++){if(r+s[n]>e/2){const o=(e/2-r)/s[n];return We(t[n],t[n+1],o)}r+=s[n]}return t[Math.round(t.length/2)]}var L=new m,R=new m,T=new m,V=new m,I=new m,$=new m;function Ge(i,t,e){L.copy(e).normalize(),R.crossVectors(i,t).normalize(),T.crossVectors(R,i).normalize(),V.copy(i).multiplyScalar(-L.dot(T)),I.copy(T).multiplyScalar(L.dot(i));const s=new m().addVectors(V,I).normalize();return $.crossVectors(s,L),s.applyAxisAngle($,.01).multiplyScalar(C.SPHERE_RADIUS)}var x=(i=>(i.image="image",i.imageLayer="imageLayer",i.videoLayer="videoLayer",i.html="html",i.element="element",i.polygon="polygon",i.polygonPixels="polygonPixels",i.polyline="polyline",i.polylinePixels="polylinePixels",i.square="square",i.rect="rect",i.circle="circle",i.ellipse="ellipse",i.path="path",i))(x||{}),qe=class j{constructor(t,e,s){if(this.viewer=t,this.plugin=e,this.visible=!0,this.state={dynamicSize:!1,anchor:null,visible:!1,staticTooltip:!1,position:null,position2D:null,positions3D:null,size:null},!s.id)throw new u("missing marker id");if(this.type=j.getType(s),this.isNormal())this.element=document.createElement("div");else if(this.isPolygon())this.element=document.createElementNS(M,"polygon");else if(this.isPolyline())this.element=document.createElementNS(M,"polyline");else if(this.isSvg()){const r=this.type==="square"?"rect":this.type,n=document.createElementNS(M,r);this.element=document.createElementNS(M,"svg"),this.domElement.appendChild(n)}else this.is3d()&&(this.element=this.__createMesh());this.is3d()||(this.element.id=`psv-marker-${s.id}`,this.element[d]=this),(this.isNormal()||this.isSvg())&&this.domElement.addEventListener("transitionend",()=>{this.domElement.style.transition=""}),this.update(s),this.type==="videoLayer"&&this.viewer.needsContinuousUpdate(!0)}get id(){return this.config.id}get data(){return this.config.data}get domElement(){return this.is3d()?null:this.element}get threeElement(){return this.is3d()?this.element:null}get video(){if(this.type==="videoLayer")return this.threeElement.children[0].material.map.image;a.logWarn(`Marker ${this.id} is not a video marker`)}destroy(){this.hideTooltip(),this.is3d()?delete this.threeElement.children[0].userData[d]:delete this.element[d],this.type==="videoLayer"&&this.viewer.needsContinuousUpdate(!1)}is3d(){return this.type==="imageLayer"||this.type==="videoLayer"}isNormal(){return this.type==="image"||this.type==="html"||this.type==="element"}isPoly(){return this.isPolygon()||this.isPolyline()}isPolyPixels(){return this.type==="polygonPixels"||this.type==="polylinePixels"}isPolyAngles(){return this.type==="polygon"||this.type==="polyline"}isPolygon(){return this.type==="polygon"||this.type==="polygonPixels"}isPolyline(){return this.type==="polyline"||this.type==="polylinePixels"}isSvg(){return this.type==="square"||this.type==="rect"||this.type==="circle"||this.type==="ellipse"||this.type==="path"}getScale(t,e,s){let r=1;if(typeof this.config.scale=="function")r=this.config.scale(t,e);else if(this.config.scale){if(Array.isArray(this.config.scale.zoom)){const[n,o]=this.config.scale.zoom;r*=n+(o-n)*C.EASINGS.inQuad(t/100)}if(Array.isArray(this.config.scale.yaw)){const[n,o]=this.config.scale.yaw,h=ze.degToRad(this.viewer.state.hFov)/2,c=Math.abs(a.getShortestArc(this.state.position.yaw,e.yaw));r*=o+(n-o)*C.EASINGS.outQuad(Math.max(0,(h-c)/h))}}return s&&this.config.hoverScale&&(r*=this.config.hoverScale.amount),r}getListContent(){var t;return this.config.listContent?this.config.listContent:(t=this.config.tooltip)!=null&&t.content?this.config.tooltip.content:this.config.html?this.config.html:this.id}showTooltip(t,e){var s;if(this.state.visible&&((s=this.config.tooltip)!=null&&s.content)&&this.state.position2D){const r={...this.config.tooltip,style:{pointerEvents:this.state.staticTooltip?"auto":"none"},data:this,top:0,left:0};if(this.isPoly()||this.is3d())if(t||e){const n=a.getPosition(this.viewer.container);r.top=e-n.y,r.left=t-n.x,r.box={width:20,height:20}}else r.top=this.state.position2D.y,r.left=this.state.position2D.x;else{const n=this.viewer.dataHelper.vector3ToViewerCoords(this.state.positions3D[0]);let o=this.state.size.width,h=this.state.size.height;this.config.hoverScale&&!this.state.staticTooltip&&(o*=this.config.hoverScale.amount,h*=this.config.hoverScale.amount),r.top=n.y-h*this.state.anchor.y+h/2,r.left=n.x-o*this.state.anchor.x+o/2,r.box={width:o,height:h}}this.tooltip?this.tooltip.update(this.config.tooltip.content,r):this.tooltip=this.viewer.createTooltip(r)}}hideTooltip(){this.tooltip&&(this.tooltip.hide(),this.tooltip=null)}update(t){const e=j.getType(t,!0);if(e!==void 0&&e!==this.type)throw new u("cannot change marker type");if(a.isExtendedPosition(t)&&(a.logWarn('Use the "position" property to configure the position of a marker'),t.position=this.viewer.dataHelper.cleanPosition(t)),"width"in t&&"height"in t&&(a.logWarn('Use the "size" property to configure the size of a marker'),t.size={width:t.width,height:t.height}),this.config=a.deepmerge(this.config,t),typeof this.config.tooltip=="string"&&(this.config.tooltip={content:this.config.tooltip}),this.config.tooltip&&!this.config.tooltip.trigger&&(this.config.tooltip.trigger="hover"),this.config.scale&&Array.isArray(this.config.scale)&&(this.config.scale={zoom:this.config.scale}),typeof this.config.hoverScale=="boolean"?this.config.hoverScale=this.config.hoverScale?this.plugin.config.defaultHoverScale||A:null:typeof this.config.hoverScale=="number"?this.config.hoverScale={amount:this.config.hoverScale}:this.config.hoverScale||(this.config.hoverScale=this.plugin.config.defaultHoverScale),this.config.hoverScale&&(this.config.hoverScale={...A,...this.plugin.config.defaultHoverScale,...this.config.hoverScale}),this.visible=this.config.visible!==!1,this.state.anchor=a.parsePoint(this.config.anchor),!this.is3d()){const s=this.domElement;s.setAttribute("class","psv-marker"),this.isNormal()||this.isSvg()?s.classList.add("psv-marker--normal"):s.classList.add("psv-marker--poly"),this.state.visible&&s.classList.add("psv-marker--visible"),this.config.tooltip&&s.classList.add("psv-marker--has-tooltip"),this.config.content&&s.classList.add("psv-marker--has-content"),this.config.className&&a.addClasses(s,this.config.className),s.style.opacity=`${this.config.opacity??1}`,this.config.style&&Object.assign(s.style,this.config.style)}this.isNormal()?this.__updateNormal():this.isPoly()?this.__updatePoly():this.isSvg()?this.__updateSvg():this.is3d()&&this.__update3d()}__updateNormal(){const t=this.domElement;if(!a.isExtendedPosition(this.config.position))throw new u("missing marker position");if(this.config.image&&!this.config.size)throw new u("missing marker size");switch(this.config.size?(this.state.dynamicSize=!1,this.state.size=this.config.size,t.style.width=this.config.size.width+"px",t.style.height=this.config.size.height+"px"):this.state.dynamicSize=!0,this.type){case"image":this.definition=this.config.image,t.style.backgroundImage=`url(${this.config.image})`;break;case"html":this.definition=this.config.html,t.innerHTML=this.config.html;break;case"element":this.definition!==this.config.element&&(this.definition=this.config.element,t.childNodes.forEach(e=>e.remove()),t.appendChild(this.config.element),this.config.element.style.display="block");break}t.style.transformOrigin=`${this.state.anchor.x*100}% ${this.state.anchor.y*100}%`,this.state.position=this.viewer.dataHelper.cleanPosition(this.config.position),this.state.positions3D=[this.viewer.dataHelper.sphericalCoordsToVector3(this.state.position)]}__updateSvg(){const t=this.domElement.firstElementChild;if(!a.isExtendedPosition(this.config.position))throw new u("missing marker position");switch(this.state.dynamicSize=!0,this.type){case"square":this.definition={x:0,y:0,width:this.config.square,height:this.config.square};break;case"rect":Array.isArray(this.config.rect)?this.definition={x:0,y:0,width:this.config.rect[0],height:this.config.rect[1]}:this.definition={x:0,y:0,width:this.config.rect.width,height:this.config.rect.height};break;case"circle":this.definition={cx:this.config.circle,cy:this.config.circle,r:this.config.circle};break;case"ellipse":Array.isArray(this.config.ellipse)?this.definition={cx:this.config.ellipse[0],cy:this.config.ellipse[1],rx:this.config.ellipse[0],ry:this.config.ellipse[1]}:this.definition={cx:this.config.ellipse.rx,cy:this.config.ellipse.ry,rx:this.config.ellipse.rx,ry:this.config.ellipse.ry};break;case"path":this.definition={d:this.config.path};break}Object.entries(this.definition).forEach(([e,s])=>{t.setAttributeNS(null,e,s)}),this.config.svgStyle?Object.entries(this.config.svgStyle).forEach(([e,s])=>{t.setAttributeNS(null,a.dasherize(e),s)}):t.setAttributeNS(null,"fill","rgba(0,0,0,0.5)"),this.domElement.style.transformOrigin=`${this.state.anchor.x*100}% ${this.state.anchor.y*100}%`,this.state.position=this.viewer.dataHelper.cleanPosition(this.config.position),this.state.positions3D=[this.viewer.dataHelper.sphericalCoordsToVector3(this.state.position)]}__updatePoly(){const t=this.domElement;this.state.dynamicSize=!0,this.config.svgStyle?(Object.entries(this.config.svgStyle).forEach(([r,n])=>{t.setAttributeNS(null,a.dasherize(r),n)}),this.isPolyline()&&!this.config.svgStyle.fill&&t.setAttributeNS(null,"fill","none")):this.isPolygon()?t.setAttributeNS(null,"fill","rgba(0,0,0,0.5)"):this.isPolyline()&&(t.setAttributeNS(null,"fill","none"),t.setAttributeNS(null,"stroke","rgb(0,0,0)"));const e=this.config[this.type];if(!Array.isArray(e[0]))for(let r=0;r<e.length;r++)e.splice(r,2,[e[r],e[r+1]]);this.isPolyPixels()?this.definition=e.map(r=>{const n=this.viewer.dataHelper.textureCoordsToSphericalCoords({textureX:r[0],textureY:r[1]});return[n.yaw,n.pitch]}):this.definition=e.map(r=>[a.parseAngle(r[0]),a.parseAngle(r[1],!0)]);const s=this.isPolygon()?H(this.definition):Ye(this.definition);this.state.position={yaw:s[0],pitch:s[1]},this.state.positions3D=this.definition.map(r=>this.viewer.dataHelper.sphericalCoordsToVector3({yaw:r[0],pitch:r[1]}))}__update3d(){var s,r,n;const t=this.threeElement,e=t.children[0];if(this.state.dynamicSize=!1,a.isExtendedPosition(this.config.position)){if(!this.config.size)throw new u("missing marker size");switch(this.state.position=this.viewer.dataHelper.cleanPosition(this.config.position),this.state.size=this.config.size,e.position.set(.5-this.state.anchor.x,this.state.anchor.y-.5,0),this.viewer.dataHelper.sphericalCoordsToVector3(this.state.position,t.position),t.lookAt(0,t.position.y,0),this.config.orientation){case"horizontal":t.rotateX(this.state.position.pitch<0?-Math.PI/2:Math.PI/2);break;case"vertical-left":t.rotateY(-Math.PI*.4);break;case"vertical-right":t.rotateY(Math.PI*.4);break}t.scale.set(this.config.size.width/100,this.config.size.height/100,1);const o=e.geometry.getAttribute("position");this.state.positions3D=[0,1,3,2].map(h=>{const c=new m;return c.fromBufferAttribute(o,h),e.localToWorld(c)})}else{if(((s=this.config.position)==null?void 0:s.length)!==4)throw new u("missing marker position");const o=this.config.position.map(p=>this.viewer.dataHelper.cleanPosition(p)),h=o.map(p=>this.viewer.dataHelper.sphericalCoordsToVector3(p)),c=H(o.map(({yaw:p,pitch:v})=>[p,v]));this.state.position={yaw:c[0],pitch:c[1]},this.state.positions3D=h;const g=e.geometry.getAttribute("position");[h[0],h[1],h[3],h[2]].forEach((p,v)=>{g.setX(v,p.x),g.setY(v,p.y),g.setZ(v,p.z)}),g.needsUpdate=!0,this.__setTextureWrap(e.material.map)}switch(this.type){case"videoLayer":if(this.definition!==this.config.videoLayer){(r=e.material.map)==null||r.dispose();const o=document.createElement("video");o.crossOrigin=this.viewer.config.withCredentials?"use-credentials":"anonymous",o.loop=!0,o.playsInline=!0,o.muted=!0,o.autoplay=!0,o.preload="metadata",o.src=this.config.videoLayer,this.viewer.container.appendChild(o),e.material.map=new De(o),a.isExtendedPosition(this.config.position)||o.addEventListener("loadedmetadata",()=>{e.material.map.userData[d]={width:o.videoWidth,height:o.videoHeight},this.__setTextureWrap(e.material.map)},{once:!0}),o.play(),this.definition=this.config.videoLayer}break;case"imageLayer":this.definition!==this.config.imageLayer&&((n=e.material.map)==null||n.dispose(),e.material.map=new Te,this.viewer.textureLoader.loadImage(this.config.imageLayer).then(o=>{a.isExtendedPosition(this.config.position)||(e.material.map.userData[d]={width:o.width,height:o.height},this.__setTextureWrap(e.material.map)),e.material.map.image=o,e.material.map.anisotropy=4,e.material.map.needsUpdate=!0,this.viewer.needsUpdate()}),this.definition=this.config.imageLayer);break}e.material.opacity=this.config.opacity??1}__setTextureWrap(t){if(!t)return;const e=t.userData[d];if(!e.height||!e.width){t.repeat.set(1,1),t.offset.set(0,0);return}const s=this.config.position.map(y=>this.viewer.dataHelper.cleanPosition(y)),r=a.greatArcDistance([s[0].yaw,s[0].pitch],[s[1].yaw,s[1].pitch]),n=a.greatArcDistance([s[3].yaw,s[3].pitch],[s[2].yaw,s[2].pitch]),o=a.greatArcDistance([s[1].yaw,s[1].pitch],[s[2].yaw,s[2].pitch]),h=a.greatArcDistance([s[0].yaw,s[0].pitch],[s[3].yaw,s[3].pitch]),c=(r+n)/(o+h),g=e.width/e.height;let p=0,v=0;c<g?p=g-c:v=1/g-1/c,t.wrapS=N,t.wrapT=N,t.repeat.set(1-p,1-v),t.offset.set(p/2,v/2),t.needsUpdate=!0}__createMesh(){const t=new je({transparent:!0,opacity:1,depthTest:!1}),e=new Oe(1,1),s=new Ne(e,t);s.userData={[d]:this};const r=new He().add(s);return Object.defineProperty(r,"visible",{enumerable:!0,get:function(){return this.children[0].userData[d].visible},set:function(n){this.children[0].userData[d].visible=n}}),r}updateSize(){if(!this.state.dynamicSize||!this.isNormal()&&!this.isSvg())return;const t=this.domElement,e=!this.state.size;if(e&&t.classList.add("psv-marker--transparent"),this.isSvg()){const s=t.firstElementChild.getBoundingClientRect();this.state.size={width:s.width,height:s.height}}else this.state.size={width:t.offsetWidth,height:t.offsetHeight};e&&t.classList.remove("psv-marker--transparent"),this.isSvg()&&(t.style.width=this.state.size.width+"px",t.style.height=this.state.size.height+"px"),this.type!=="element"&&(this.state.dynamicSize=!1)}static getType(t,e=!1){const s=[];if(Object.keys(x).forEach(r=>{t[r]&&s.push(r)}),s.length===0&&!e)throw new u(`missing marker content, either ${Object.keys(x).join(", ")}`);if(s.length>1)throw new u(`multiple marker content, either ${Object.keys(x).join(", ")}`);return s[0]}},Ke=a.getConfigParser({clickEventOnMarker:!1,gotoMarkerSpeed:"8rpm",markers:null,defaultHoverScale:null},{defaultHoverScale(i){return i?(i===!0&&(i=A),typeof i=="number"&&(i={amount:i}),{...A,...i}):null}}),P=class extends Ce{constructor(i,t){super(i,t),this.markers={},this.state={visible:!0,showAllTooltips:!1,currentMarker:null,hoveringMarker:null},this.container=document.createElement("div"),this.container.className="psv-markers",this.viewer.container.appendChild(this.container),this.svgContainer=document.createElementNS(M,"svg"),this.svgContainer.setAttribute("class","psv-markers-svg-container"),this.container.appendChild(this.svgContainer),this.container.addEventListener("mouseenter",this,!0),this.container.addEventListener("mouseleave",this,!0),this.container.addEventListener("mousemove",this,!0),this.container.addEventListener("contextmenu",this)}init(){super.init(),a.checkStylesheet(this.viewer.container,"markers-plugin"),this.viewer.addEventListener(l.ClickEvent.type,this),this.viewer.addEventListener(l.DoubleClickEvent.type,this),this.viewer.addEventListener(l.RenderEvent.type,this),this.viewer.addEventListener(l.ConfigChangedEvent.type,this),this.viewer.addEventListener(l.ObjectEnterEvent.type,this),this.viewer.addEventListener(l.ObjectHoverEvent.type,this),this.viewer.addEventListener(l.ObjectLeaveEvent.type,this),this.viewer.addEventListener(l.ReadyEvent.type,this,{once:!0})}destroy(){this.clearMarkers(!1),this.viewer.unobserveObjects(d),this.viewer.removeEventListener(l.ClickEvent.type,this),this.viewer.removeEventListener(l.DoubleClickEvent.type,this),this.viewer.removeEventListener(l.RenderEvent.type,this),this.viewer.removeEventListener(l.ObjectEnterEvent.type,this),this.viewer.removeEventListener(l.ObjectHoverEvent.type,this),this.viewer.removeEventListener(l.ObjectLeaveEvent.type,this),this.viewer.removeEventListener(l.ReadyEvent.type,this),this.viewer.container.removeChild(this.container),super.destroy()}handleEvent(i){var t;switch(i.type){case l.ReadyEvent.type:this.config.markers&&(this.setMarkers(this.config.markers),delete this.config.markers);break;case l.RenderEvent.type:this.renderMarkers();break;case l.ClickEvent.type:this.__onClick(i,!1);break;case l.DoubleClickEvent.type:this.__onClick(i,!0);break;case l.ObjectEnterEvent.type:case l.ObjectLeaveEvent.type:case l.ObjectHoverEvent.type:if(i.userDataKey===d){const e=i.originalEvent,s=i.object.userData[d];switch(i.type){case l.ObjectEnterEvent.type:(t=s.config.style)!=null&&t.cursor?this.viewer.setCursor(s.config.style.cursor):(s.config.tooltip||s.config.content)&&this.viewer.setCursor("pointer"),this.__onEnterMarker(e,s);break;case l.ObjectLeaveEvent.type:this.viewer.setCursor(null),this.__onLeaveMarker(s);break;case l.ObjectHoverEvent.type:this.__onHoverMarker(e,s);break}}break;case"mouseenter":this.__onEnterMarker(i,this.__getTargetMarker(i.target));break;case"mouseleave":this.__onLeaveMarker(this.__getTargetMarker(i.target));break;case"mousemove":this.__onHoverMarker(i,this.__getTargetMarker(i.target,!0));break;case"contextmenu":i.preventDefault();break}}toggleAllMarkers(){this.state.visible?this.hideAllMarkers():this.showAllMarkers()}showAllMarkers(){this.state.visible=!0,this.renderMarkers(),this.dispatchEvent(new _)}hideAllMarkers(){this.state.visible=!1,this.renderMarkers(),this.dispatchEvent(new b)}toggleAllTooltips(){this.state.showAllTooltips?this.hideAllTooltips():this.showAllTooltips()}showAllTooltips(){this.state.showAllTooltips=!0,Object.values(this.markers).forEach(i=>{i.state.staticTooltip=!0,i.showTooltip()})}hideAllTooltips(){this.state.showAllTooltips=!1,Object.values(this.markers).forEach(i=>{i.state.staticTooltip=!1,i.hideTooltip()})}getNbMarkers(){return Object.keys(this.markers).length}getMarkers(){return Object.values(this.markers)}addMarker(i,t=!0){if(this.markers[i.id])throw new u(`marker "${i.id}" already exists`);const e=new qe(this.viewer,this,i);e.isPoly()?this.svgContainer.appendChild(e.domElement):e.is3d()?this.viewer.renderer.addObject(e.threeElement):this.container.appendChild(e.domElement),this.markers[e.id]=e,this.state.showAllTooltips&&(e.state.staticTooltip=!0),t&&this.__afterChangerMarkers()}getMarker(i){const t=typeof i=="object"?i.id:i;if(!this.markers[t])throw new u(`cannot find marker "${t}"`);return this.markers[t]}getCurrentMarker(){return this.state.currentMarker}updateMarker(i,t=!0){var s;const e=this.getMarker(i.id);e.update(i),t&&(this.__afterChangerMarkers(),(e===this.state.hoveringMarker&&((s=e.config.tooltip)==null?void 0:s.trigger)==="hover"||e.state.staticTooltip)&&e.showTooltip())}removeMarker(i,t=!0){const e=this.getMarker(i);e.isPoly()?this.svgContainer.removeChild(e.domElement):e.is3d()?this.viewer.renderer.removeObject(e.threeElement):this.container.removeChild(e.domElement),this.state.hoveringMarker===e&&(this.state.hoveringMarker=null),this.state.currentMarker===e&&(this.state.currentMarker=null),e.destroy(),delete this.markers[e.id],t&&this.__afterChangerMarkers()}removeMarkers(i,t=!0){i.forEach(e=>this.removeMarker(e,!1)),t&&this.__afterChangerMarkers()}setMarkers(i,t=!0){this.clearMarkers(!1),i==null||i.forEach(e=>{this.addMarker(e,!1)}),t&&this.__afterChangerMarkers()}clearMarkers(i=!0){Object.keys(this.markers).forEach(t=>{this.removeMarker(t,!1)}),i&&this.__afterChangerMarkers()}gotoMarker(i,t=this.config.gotoMarkerSpeed){const e=this.getMarker(i);return t?this.viewer.animate({...e.state.position,zoom:e.config.zoomLvl,speed:t}).then(()=>{this.dispatchEvent(new D(e))}):(this.viewer.rotate(e.state.position),a.isNil(e.config.zoomLvl)||this.viewer.zoom(e.config.zoomLvl),this.dispatchEvent(new D(e)),Promise.resolve())}hideMarker(i){this.toggleMarker(i,!1)}showMarker(i){this.toggleMarker(i,!0)}showMarkerTooltip(i){const t=this.getMarker(i);t.state.staticTooltip=!0,t.showTooltip()}hideMarkerTooltip(i){const t=this.getMarker(i);t.state.staticTooltip=!1,t.hideTooltip()}toggleMarker(i,t){const e=this.getMarker(i);e.visible=t===null?!e.visible:t,this.viewer.needsUpdate()}showMarkerPanel(i){var e;const t=this.getMarker(i);(e=t==null?void 0:t.config)!=null&&e.content?this.viewer.panel.show({id:E,content:t.config.content}):this.hideMarkerPanel()}hideMarkerPanel(){this.viewer.panel.hide(E)}toggleMarkersList(){this.viewer.panel.isVisible(k)?this.hideMarkersList():this.showMarkersList()}showMarkersList(){let i=[];Object.values(this.markers).forEach(e=>{e.visible&&!e.config.hideList&&i.push(e)});const t=new Me(i);this.dispatchEvent(t),i=t.markers,this.viewer.panel.show({id:k,content:Ue(i,this.viewer.config.lang[S.id]),noMargin:!0,clickHandler:e=>{const s=a.getClosest(e,"li"),r=s?s.dataset[d]:void 0;if(r){const n=this.getMarker(r);this.dispatchEvent(new le(n)),this.gotoMarker(n.id),this.hideMarkersList()}}})}hideMarkersList(){this.viewer.panel.hide(k)}renderMarkers(){const i=this.viewer.getZoomLevel(),t=this.viewer.getPosition();Object.values(this.markers).forEach(e=>{var o,h;let s=this.state.visible&&e.visible,r=!1,n=null;if(s&&e.is3d())n=this.__getMarkerPosition(e),s=this.__isMarkerVisible(e,n);else if(s&&e.isPoly()){const c=this.__getPolyPositions(e);if(s=c.length>(e.isPolygon()?2:1),s){n=this.__getMarkerPosition(e);const g=c.map(p=>p.x-n.x+","+(p.y-n.y)).join(" ");e.domElement.setAttributeNS(null,"points",g),e.domElement.setAttributeNS(null,"transform",`translate(${n.x} ${n.y})`)}}else s&&(e.updateSize(),n=this.__getMarkerPosition(e),s=this.__isMarkerVisible(e,n),s&&(e.domElement.style.translate=`${n.x}px ${n.y}px 0px`,this.__applyScale(e,{zoomLevel:i,viewerPosition:t,mouseover:e===this.state.hoveringMarker}),e.type==="element"&&((h=(o=e.config.element).updateMarker)==null||h.call(o,{marker:e,position:n,viewerPosition:t,zoomLevel:i,viewerSize:this.viewer.state.size}))));r=e.state.visible!==s,e.state.visible=s,e.state.position2D=s?n:null,e.is3d()||a.toggleClass(e.domElement,"psv-marker--visible",s),s?e.state.staticTooltip?e.showTooltip():e!==this.state.hoveringMarker&&e.hideTooltip():e.hideTooltip(),r&&this.dispatchEvent(new X(e,s))})}__applyScale(i,{zoomLevel:t,viewerPosition:e,mouseover:s}){s!==null&&i.config.hoverScale&&(i.domElement.style.transition=`scale ${i.config.hoverScale.duration}ms ${i.config.hoverScale.easing}`);const r=i.getScale(t,e,s);i.domElement.style.scale=`${r}`}__isMarkerVisible(i,t){return i.is3d()?i.state.positions3D.some(e=>this.viewer.dataHelper.isPointVisible(e)):i.state.positions3D[0].dot(this.viewer.state.direction)>0&&t.x+i.state.size.width>=0&&t.x-i.state.size.width<=this.viewer.state.size.width&&t.y+i.state.size.height>=0&&t.y-i.state.size.height<=this.viewer.state.size.height}__getMarkerPosition(i){if(i.isPoly()||i.is3d())return this.viewer.dataHelper.sphericalCoordsToViewerCoords(i.state.position);{const t=this.viewer.dataHelper.vector3ToViewerCoords(i.state.positions3D[0]);return t.x-=i.state.size.width*i.state.anchor.x,t.y-=i.state.size.height*i.state.anchor.y,t}}__getPolyPositions(i){const t=i.state.positions3D.length,e=i.state.positions3D.map(r=>({vector:r,visible:r.dot(this.viewer.state.direction)>0})),s=[];return e.forEach((r,n)=>{r.visible||[n===0?e[t-1]:e[n-1],n===t-1?e[0]:e[n+1]].forEach(h=>{h.visible&&s.push({visible:h.vector,invisible:r.vector,index:n})})}),s.reverse().forEach(r=>{e.splice(r.index,0,{vector:Ge(r.visible,r.invisible,this.viewer.state.direction),visible:!0})}),e.filter(r=>r.visible).map(r=>this.viewer.dataHelper.vector3ToViewerCoords(r.vector))}__getTargetMarker(i,t=!1){const e=t?a.getClosest(i,".psv-marker"):i;return e?e[d]:void 0}__onEnterMarker(i,t){var e;t&&(this.state.hoveringMarker=t,this.dispatchEvent(new se(t)),(t.isNormal()||t.isSvg())&&this.__applyScale(t,{zoomLevel:this.viewer.getZoomLevel(),viewerPosition:this.viewer.getPosition(),mouseover:!0}),!t.state.staticTooltip&&((e=t.config.tooltip)==null?void 0:e.trigger)==="hover"&&t.showTooltip(i.clientX,i.clientY))}__onLeaveMarker(i){var t;i&&(this.dispatchEvent(new ee(i)),(i.isNormal()||i.isSvg())&&this.__applyScale(i,{zoomLevel:this.viewer.getZoomLevel(),viewerPosition:this.viewer.getPosition(),mouseover:!1}),this.state.hoveringMarker=null,!i.state.staticTooltip&&((t=i.config.tooltip)==null?void 0:t.trigger)==="hover"?i.hideTooltip():i.state.staticTooltip&&i.showTooltip())}__onHoverMarker(i,t){var e;t&&(t.isPoly()||t.is3d())&&((e=t.config.tooltip)==null?void 0:e.trigger)==="hover"&&t.showTooltip(i.clientX,i.clientY)}__onClick(i,t){var s,r,n;let e=(s=i.data.objects.find(o=>o.userData[d]))==null?void 0:s.userData[d];e||(e=this.__getTargetMarker(i.data.target,!0)),this.state.currentMarker&&this.state.currentMarker!==e&&(this.dispatchEvent(new de(this.state.currentMarker)),this.viewer.panel.hide(E),!this.state.showAllTooltips&&((r=this.state.currentMarker.config.tooltip)==null?void 0:r.trigger)==="click"&&this.hideMarkerTooltip(this.state.currentMarker.id),this.state.currentMarker=null),e&&(this.state.currentMarker=e,this.dispatchEvent(new oe(e,t,i.data.rightclick)),this.config.clickEventOnMarker?i.data.marker=e:i.stopImmediatePropagation(),this.markers[e.id]&&(((n=e.config.tooltip)==null?void 0:n.trigger)==="click"?e.tooltip?this.hideMarkerTooltip(e):this.showMarkerTooltip(e):this.showMarkerPanel(e.id)))}__afterChangerMarkers(){this.__refreshUi(),this.__checkObjectsObserver(),this.viewer.needsUpdate(),this.dispatchEvent(new me(this.getMarkers()))}__refreshUi(){var t,e;const i=Object.values(this.markers).filter(s=>!s.config.hideList).length;i===0?(this.viewer.panel.isVisible(k)||this.viewer.panel.isVisible(E))&&this.viewer.panel.hide():this.viewer.panel.isVisible(k)?this.showMarkersList():this.viewer.panel.isVisible(E)&&(this.state.currentMarker?this.showMarkerPanel(this.state.currentMarker.id):this.viewer.panel.hide()),(t=this.viewer.navbar.getButton(S.id,!1))==null||t.toggle(i>0),(e=this.viewer.navbar.getButton(z.id,!1))==null||e.toggle(i>0)}__checkObjectsObserver(){Object.values(this.markers).some(t=>t.is3d())?this.viewer.observeObjects(d):this.viewer.unobserveObjects(d)}};P.id="markers";P.configParser=Ke;P.readonlyOptions=["markers"];W.lang[S.id]="Markers";W.lang[z.id]="Markers list";Y(S,"caption:left");Y(z,"caption:left");const Xe="/demos/assets/danger-06bd2106.png",Ze="/demos/assets/enter-58d6d179.png",Fe="/demos/assets/jump-ec5fe5df.png",B="/demos/assets/p1-3efa2207.jpg",Qe="/demos/assets/p2-c0def234.jpg";const w={pitch:{start:-Math.PI/2,end:.2},yaw:{start:Math.PI,end:0},zoom:{start:0,end:50},fisheye:{start:2,end:0}},U=[{id:"p1_door",imageLayer:Ze,size:{width:56,height:56},position:{textureX:2654,textureY:1095},tooltip:"test2"},{id:"window",imageLayer:Xe,size:{width:56,height:56},position:{textureX:2170,textureY:988},tooltip:"test1"}],Je=[{id:"p2_out",imageLayer:Fe,size:{width:100,height:100},position:{textureX:1380,textureY:515},tooltip:"click"}];function rt(){const i=Pe.createRef(),t=r=>{var h;i.current.getPlugin(O).stop(),new a.Animation({properties:w,duration:1500,easing:"inOutQuad",onTick:c=>{r.setOption("fisheye",c.fisheye),r.rotate({yaw:c.yaw,pitch:c.pitch}),r.zoom(c.zoom)}});const o=r.getPlugin(P);console.log("ðŸš€ ~ file: index.tsx:71 ~ handleReady ~ markersPlugin:",o),(h=o==null?void 0:o.addEventListener)==null||h.call(o,"select-marker",({marker:c,doubleClick:g,rightClick:p})=>{console.log("-----",c);let v=[],y="";if(c.id==="p1_door")y=Qe,v=Je;else if(c.id==="p2_out")y=B,v=U;else return;o.clearMarkers(),r.setPanorama(y,{position:{yaw:0,pitch:0}}).then(()=>{v.forEach(Se=>{o.addMarker(Se)})})})},e=[[P,{markers:U}],[O,{autostartDelay:null,autostartOnIdle:!1,autorotatePitch:w.pitch.end}]],s=r=>{console.log(r,[r.data.yaw,r.data.pitch])};return Le(Ae,{ref:i,options:{panorama:B,size:{height:"100%",width:"100%"},navbar:!1,defaultPitch:w.pitch.start,defaultYaw:w.yaw.start,defaultZoomLvl:w.zoom.start,fisheye:w.fisheye.start,plugins:e},onClick:s,onReady:t})}export{rt as default};
